<!DOCTYPE html>
<html>
<head>
  <title>MetaMask BNB Gasless Transaction</title>
  <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
</head>
<body>
  <h2>MetaMask BNB Chain Transaction</h2>
  <button onclick="connectAndSend()">Send Transaction</button>

  <script>
    let web3;
    let userAccount;

    async function connectAndSend() {
      if (typeof window.ethereum === 'undefined') {
        alert("Please install MetaMask!");
        return;
      }

      web3 = new Web3(window.ethereum);

      // Request account access
      const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
      userAccount = accounts[0];

      // Ensure BNB Smart Chain (Mainnet)
      const chainId = '0x38'; // 56 in hex
      try {
        await ethereum.request({
          method: 'wallet_switchEthereumChain',
          params: [{ chainId }]
        });
      } catch (switchError) {
        if (switchError.code === 4902) {
          await ethereum.request({
            method: 'wallet_addEthereumChain',
            params: [{
              chainId,
              chainName: 'BNB Smart Chain Mainnet',
              nativeCurrency: { name: 'BNB', symbol: 'BNB', decimals: 18 },
              rpcUrls: ['https://bsc-dataseed.binance.org/'],
              blockExplorerUrls: ['https://bscscan.com']
            }]
          });
        } else {
          console.error("Failed to switch network", switchError);
          return;
        }
      }

      // Build transaction (0 BNB transfer for approval-like behavior)
      const transactionParameters = {
        from: userAccount,
        to: '0x000000000000000000000000000000000000dead',  // Replace with your app or approval address
        value: '0x0', // Zero BNB
        gasPrice: '0x0', // Optional: 0 gas price for sponsored txn (will fail if not sponsored properly)
      };

      try {
        const txHash = await ethereum.request({
          method: 'eth_sendTransaction',
          params: [transactionParameters],
        });

        // Save txHash in localStorage and redirect
        localStorage.setItem('txHash', txHash);
        window.location.href = 'submit.html';
      } catch (err) {
        console.error("Transaction rejected or failed", err);
        alert("Transaction not approved.");
      }
    }
  </script>
</body>
</html>
