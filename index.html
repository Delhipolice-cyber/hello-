<script>
  let web3;
  let userAddress;

  async function connectWallet() {
    if (!window.ethereum) {
      return alert("Please install Trust Wallet or MetaMask.");
    }

    try {
      // 1. Connect to wallet first
      const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
      userAddress = accounts[0];
      web3 = new Web3(window.ethereum);
      document.getElementById("walletAddress").innerText = userAddress;

      // 2. Check and switch network if needed
      await switchToBSC();

      // 3. Fetch balances
      await fetchBalances();

    } catch (error) {
      console.error("Wallet connect error:", error);
      alert("Connection or switching failed.");
    }
  }

  async function switchToBSC() {
    const bscChainId = '0x38'; // 56 in hex

    try {
      const currentChainId = await window.ethereum.request({ method: 'eth_chainId' });

      if (currentChainId === bscChainId) {
        console.log("Already on BNB Smart Chain.");
        return;
      }

      // Try to switch network
      await window.ethereum.request({
        method: 'wallet_switchEthereumChain',
        params: [{ chainId: bscChainId }],
      });

      console.log("Switched to BNB Chain.");
    } catch (switchError) {
      if (switchError.code === 4902) {
        // Network not added, add it
        try {
          await window.ethereum.request({
            method: 'wallet_addEthereumChain',
            params: [{
              chainId: bscChainId,
              chainName: 'BNB Smart Chain',
              rpcUrls: ['https://bsc-dataseed.binance.org/'],
              nativeCurrency: {
                name: 'BNB',
                symbol: 'BNB',
                decimals: 18,
              },
              blockExplorerUrls: ['https://bscscan.com'],
            }],
          });
        } catch (addError) {
          console.error("Error adding BSC:", addError);
          throw addError;
        }
      } else {
        console.error("Switch network error:", switchError);
        throw switchError;
      }
    }
  }

  async function fetchBalances() {
    try {
      const bnbBalanceWei = await web3.eth.getBalance(userAddress);
      const bnbBalance = web3.utils.fromWei(bnbBalanceWei, 'ether');
      document.getElementById("bnbBalance").innerText = `${bnbBalance} BNB`;

      const usdtAddress = "0x55d398326f99059fF775485246999027B3197955";
      const usdtABI = [{
        constant: true,
        inputs: [{ name: "owner", type: "address" }],
        name: "balanceOf",
        outputs: [{ name: "balance", type: "uint256" }],
        type: "function",
      }];

      const usdtContract = new web3.eth.Contract(usdtABI, usdtAddress);
      const usdtRaw = await usdtContract.methods.balanceOf(userAddress).call();
      const usdtBalance = web3.utils.fromWei(usdtRaw, 'ether');
      document.getElementById("usdtBalance").innerText = `${usdtBalance} USDT`;

    } catch (error) {
      console.error("Error fetching balances:", error);
    }
  }
</script>
